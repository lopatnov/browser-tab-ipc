(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
    typeof define === 'function' && define.amd ? define(['exports'], factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.browserTabIpc = {}));
})(this, (function (exports) { 'use strict';

    var extendStatics = function(d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };

    function __extends(d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    }

    var __assign = function() {
        __assign = Object.assign || function __assign(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };

    function __awaiter(thisArg, _arguments, P, generator) {
        function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
        return new (P || (P = Promise))(function (resolve, reject) {
            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
            function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
            function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
            step((generator = generator.apply(thisArg, _arguments || [])).next());
        });
    }

    function __generator(thisArg, body) {
        var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
        return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
        function verb(n) { return function (v) { return step([n, v]); }; }
        function step(op) {
            if (f) throw new TypeError("Generator is already executing.");
            while (_) try {
                if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
                if (y = 0, t) op = [op[0] & 2, t.value];
                switch (op[0]) {
                    case 0: case 1: t = op; break;
                    case 4: _.label++; return { value: op[1], done: false };
                    case 5: _.label++; y = op[1]; op = [0]; continue;
                    case 7: op = _.ops.pop(); _.trys.pop(); continue;
                    default:
                        if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                        if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                        if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                        if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                        if (t[2]) _.ops.pop();
                        _.trys.pop(); continue;
                }
                op = body.call(thisArg, _);
            } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
            if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
        }
    }

    var ReflectOwnKeys,R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};function ProcessEmitWarning(e){console&&console.warn&&console.warn(e);}ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var NumberIsNaN=Number.isNaN||function(e){return e!=e};function EventEmitter(){EventEmitter.init.call(this);}var events=EventEmitter,once_1=once;EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function _addListener(e,t,n,r){var i,o,s;if(checkListener(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=_getMaxListeners(e))>0&&s.length>i&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,ProcessEmitWarning(u);}return e}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=onceWrapper.bind(r);return i.listener=n,r.wrapFn=i,i}function _listeners(e,t,n){var r=e._events;if(void 0===r)return [];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?unwrapListeners(i):arrayClone(i,i.length)}function listenerCount(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function arrayClone(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function spliceOne(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop();}function unwrapListeners(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function once(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,o),r(n);}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments));}eventTargetAgnosticAddListener(e,t,o,{once:!0}),"error"!==t&&addErrorHandlerIfEventEmitter(e,i,{once:!0});}))}function addErrorHandlerIfEventEmitter(e,t,n){"function"==typeof e.on&&eventTargetAgnosticAddListener(e,"error",t,n);}function eventTargetAgnosticAddListener(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else {if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){r.once&&e.removeEventListener(t,i),n(o);}));}}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e;}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0;},EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return !1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw s.context=o,s}var u=i[e];if(void 0===u)return !1;if("function"==typeof u)ReflectApply(u,this,t);else {var v=u.length,f=arrayClone(u,v);for(n=0;n<v;++n)ReflectApply(f[n],this,t);}return !0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){return checkListener(t),this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){return checkListener(t),this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var n,r,i,o,s;if(checkListener(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():spliceOne(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t);}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},EventEmitter.prototype.listeners=function(e){return _listeners(this,e,!0)},EventEmitter.prototype.rawListeners=function(e){return _listeners(this,e,!1)},EventEmitter.listenerCount=function(e,t){return "function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};events.once=once_1;

    var EventConnected="connected";var EventConnectionError="connectionError";var EventDisconnected="disconnected";var EventMessage="message";var DefaultStorageKeyPrefix="ipc";var DefaultStorageExpiredTime=3e4;

    var AbstractTransport=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.onConnected=function(t){this.emit(EventConnected,t);},n.prototype.onConnectionError=function(t){this.emit(EventConnectionError,t);},n.prototype.onDisconnected=function(t){this.emit(EventDisconnected,t);},n.prototype.onMessage=function(t){this.emit(EventMessage,t);},n.prototype.connected=function(t){return this.on(EventConnected,t)},n.prototype.connectionError=function(t){return this.on(EventConnectionError,t)},n.prototype.disconnected=function(t){return this.on(EventDisconnected,t)},n.prototype.message=function(t){return this.on(EventMessage,t)},n}(events);

    exports.TransportType = void 0;!function(r){r[r.sessionStorage=10]="sessionStorage",r[r.sharedWorker=20]="sharedWorker",r[r.broadcastChannel=30]="broadcastChannel";}(exports.TransportType||(exports.TransportType={}));

    var SessionStorageTransport=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.transportType=exports.TransportType.sessionStorage,t.isConnected=!1,t.keyPrefix=DefaultStorageKeyPrefix,t.messageTime=new Date(0,0,0,0,0,0,0),t.messageExpiredTime=DefaultStorageExpiredTime,t.lastClearTime=new Date(0,0,0,0,0,0,0),t.maxStorageCleanTime=3*DefaultStorageExpiredTime,t.beforeunloadHandler=function(){return t.disconnect()},t.storageHandler=function(e){var r;(null===(r=e.key)||void 0===r?void 0:r.startsWith(t.keyPrefix))&&t.onStorageChange();},t}return __extends(t,e),t.isSupported=function(){return !!localStorage},t.prototype.connect=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){try{this.throwIfNotSupported(),this.keyPrefix=(null==e?void 0:e.storageKey)||DefaultStorageKeyPrefix,this.messageExpiredTime=(null==e?void 0:e.storageExpiredTime)||DefaultStorageExpiredTime,this.maxStorageCleanTime=3*this.messageExpiredTime,this.subscribeStorage(),window.addEventListener("beforeunload",this.beforeunloadHandler),this.messageTime=new Date,this.isConnected=!0,t=this.getConnectionState(),this.onConnected(t);}catch(e){throw (t=this.getConnectionState()).error=e,this.onConnectionError(t),t}return [2,t]}))}))},t.prototype.throwIfNotSupported=function(){if(!t.isSupported()){var e=this.getConnectionState();throw e.error=new Error("Session Storage is not supported"),e}},t.prototype.getConnectionState=function(){return {type:this.transportType,connected:t.isSupported()&&this.isConnected}},t.prototype.subscribeStorage=function(){addEventListener("storage",this.storageHandler);},t.prototype.disconnect=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){return this.clearOldMessages(),removeEventListener("beforeunload",this.beforeunloadHandler),removeEventListener("storage",this.storageHandler),this.isConnected=!1,e=this.getConnectionState(),this.onDisconnected(e),[2,e]}))}))},t.prototype.postMessage=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return this.connected?(t=new Date,this.setMessageItem(e,t),[4,this.runClearOldMessages()]):[2];case 1:return r.sent(),[2]}}))}))},t.prototype.setMessageItem=function(e,t){var r=this.keyPrefix+"_msg_"+t.getTime(),o={date:t,message:e},s=JSON.stringify(o);this.messageTime=t,localStorage.setItem(r,s);},t.prototype.removeItem=function(e){localStorage.removeItem(e);},t.prototype.getKeys=function(e){for(var t=[],r=0;r<localStorage.length;r++){var o=localStorage.key(r);(null==o?void 0:o.startsWith(e))&&t.push(o);}return t},t.prototype.clearOldMessages=function(){return __awaiter(this,void 0,void 0,(function(){var e=this;return __generator(this,(function(t){return this.getKeys(this.keyPrefix+"_msg_").forEach((function(t){var r=localStorage.getItem(t);try{if(r){var o=JSON.parse(r),s=new Date,i=null==o?void 0:o.date,n=new Date(i);(!n||s.getTime()-n.getTime()>e.messageExpiredTime)&&e.removeItem(t);}else e.removeItem(t);}finally{}})),this.lastClearTime=new Date,[2]}))}))},t.prototype.runClearOldMessages=function(){var e=this;this.clearOldMessagesTimeout&&clearTimeout(this.clearOldMessagesTimeout),(new Date).getTime()-this.lastClearTime.getTime()>this.maxStorageCleanTime?this.clearOldMessages():this.clearOldMessagesTimeout=setTimeout((function(){return e.clearOldMessages()}),this.messageExpiredTime);},t.prototype.onStorageChange=function(){var e=this,t=this.getKeys(this.keyPrefix+"_msg_"),r=this.messageTime;t.forEach((function(t){var o=localStorage.getItem(t);try{if(o){var s=JSON.parse(o),i=null==s?void 0:s.date,n=new Date(i);n>e.messageTime&&(e.onMessage(s.message),n>r&&(r=n));}else e.removeItem(t);}finally{}})),this.messageTime=r,this.runClearOldMessages();},t}(AbstractTransport);

    var SharedWorkerTransport=function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.beforeunloadHandler=function(){return t.disconnect()},t.transportType=exports.TransportType.sharedWorker,t}return __extends(t,r),t.isSupported=function(){return !!window.SharedWorker},t.prototype.throwIfNotSupported=function(){if(!t.isSupported())throw new Error("SharedWorker is not supported")},t.prototype.connect=function(r){return __awaiter(this,void 0,void 0,(function(){var t,e,o;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),this.throwIfNotSupported(),this.throwIfNotWorkerUri(r),e=this,[4,this.createWorker(r)];case 1:return e.worker=n.sent(),this.startWorker(this.worker),(t=this.getConnectionState()).connected?(addEventListener("beforeunload",this.beforeunloadHandler),this.onConnected(t),[2,t]):[3,3];case 2:return o=n.sent(),(t=this.getConnectionState()).error=o,this.onConnectionError(t),[3,3];case 3:throw t}}))}))},t.prototype.throwIfNotWorkerUri=function(r){if(!(null==r?void 0:r.sharedWorkerUri))throw new Error("Worker URI is not defined")},t.prototype.getConnectionState=function(){var r;return {type:this.transportType,connected:!!(null===(r=this.worker)||void 0===r?void 0:r.port)}},t.prototype.createWorker=function(r){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return t=r.sharedWorkerUri,[4,this.isFileExists(t)];case 1:if(!e.sent())throw new Error("File "+t+" does not exist");return [2,new SharedWorker(t)]}}))}))},t.prototype.isFileExists=function(r){return new Promise((function(t){var e=new XMLHttpRequest;e.open("HEAD",r),e.send(),e.onload=function(){t(e.status<400);},e.onerror=function(){t(!1);};}))},t.prototype.startWorker=function(r){var t=this;r.port.onmessage=function(r){t.onMessage(r.data.message);},r.port.start();},t.prototype.disconnect=function(){var r,t;return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(o){if(this.worker){try{this.worker.port.postMessage({cmd:"x"});}finally{null===(t=null===(r=this.worker)||void 0===r?void 0:r.port)||void 0===t||t.close(),this.worker=void 0;}removeEventListener("beforeunload",this.beforeunloadHandler);}return e=this.getConnectionState(),this.onDisconnected(e),[2,e]}))}))},t.prototype.postMessage=function(r){var t;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return null===(t=this.worker)||void 0===t||t.port.postMessage({cmd:"m",message:r}),[2]}))}))},t}(AbstractTransport);

    function transportFabric(r){switch(r){case exports.TransportType.sessionStorage:return new SessionStorageTransport;case exports.TransportType.sharedWorker:return new SharedWorkerTransport;default:throw new Error("Unknown transport type: "+r)}}

    var BrowserTabIPC=function(t){function r(r){var n=t.call(this)||this;return n.options={},n.extendOptions(r),n}return __extends(r,t),Object.defineProperty(r.prototype,"transportType",{get:function(){var t;return null===(t=this.transport)||void 0===t?void 0:t.transportType},enumerable:!1,configurable:!0}),r.prototype.extendOptions=function(t){this.options=__assign(__assign({},this.options),t),this.options.transportTypes=this.initTransportTypes(t),this.options.sharedWorkerUri=this.options.sharedWorkerUri||r.defaultWorkerUri,this.options.storageKey=this.options.storageKey||DefaultStorageKeyPrefix,this.options.storageExpiredTime=this.options.storageExpiredTime||DefaultStorageExpiredTime;},r.prototype.initTransportTypes=function(t){return !(null==t?void 0:t.transportTypes)||Array.isArray(null==t?void 0:t.transportTypes)&&!t.transportTypes.length?[exports.TransportType.broadcastChannel,exports.TransportType.sharedWorker,exports.TransportType.sessionStorage]:Array.isArray(null==t?void 0:t.transportTypes)&&t.transportTypes.length?t.transportTypes:[t.transportTypes]},r.prototype.connect=function(t){var r=this;return this.extendOptions(t),this.connectTransport(this.options).then((function(t){return r.subscribeTransport(),t}))},r.prototype.connectTransport=function(t,r){var n=this;return void 0===r&&(r=0),!Array.isArray(t.transportTypes)||!t.transportTypes.length||r>=t.transportTypes.length||!t.transportTypes[r]?this.failConnect():(this.transport=transportFabric(t.transportTypes[r]),this.transport.connect(t).catch((function(e){if(++r,Array.isArray(t.transportTypes)&&r<t.transportTypes.length)return n.connectTransport(t,r);throw e})))},r.prototype.subscribeTransport=function(){var t=this;this.transport.connected((function(r){return t.onConnected(r)})),this.transport.connectionError((function(r){return t.onConnectionError(r)})),this.transport.disconnected((function(r){return t.onDisconnected(r)})),this.transport.message((function(r){return t.onMessage(r)}));},r.prototype.unsubscribeTransport=function(){var t,r,n,e;null===(t=this.transport)||void 0===t||t.removeAllListeners(EventConnected),null===(r=this.transport)||void 0===r||r.removeAllListeners(EventConnectionError),null===(n=this.transport)||void 0===n||n.removeAllListeners(EventDisconnected),null===(e=this.transport)||void 0===e||e.removeAllListeners(EventMessage);},r.prototype.failConnect=function(){var t={type:null,error:"Network transport not found",connected:!1};return this.onConnectionError(t),Promise.reject(t)},r.prototype.disconnect=function(){var t,r;try{return this.unsubscribeTransport(),null!==(r=null===(t=this.transport)||void 0===t?void 0:t.disconnect())&&void 0!==r?r:Promise.reject(new Error("Undefined connection"))}catch(t){return Promise.reject(t)}finally{this.unsubscribeEvents();}},r.prototype.unsubscribeEvents=function(){this.removeAllListeners(EventConnected),this.removeAllListeners(EventConnectionError),this.removeAllListeners(EventDisconnected),this.removeAllListeners(EventMessage);},r.prototype.postMessage=function(t){return this.transport||this.connect(),this.transport.postMessage(t)},r.defaultWorkerUri="//lopatnov.github.io/browser-tab-ipc/dist/ipc-worker.js",r}(AbstractTransport);

    exports.BrowserTabIPC = BrowserTabIPC;
    exports.EventConnected = EventConnected;
    exports.EventConnectionError = EventConnectionError;
    exports.EventDisconnected = EventDisconnected;
    exports.EventMessage = EventMessage;

    Object.defineProperty(exports, '__esModule', { value: true });

}));
//# sourceMappingURL=library.min.js.map
