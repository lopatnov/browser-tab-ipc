!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).browserTabIpc={})}(this,function(e){"use strict";function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r,n={exports:{}};var s=function(){if(r)return n.exports;r=1;var e,t="object"==typeof Reflect?Reflect:null,s=t&&"function"==typeof t.apply?t.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}n.exports=i,n.exports.once=function(e,t){return new Promise(function(r,n){function s(r){e.removeListener(t,o),n(r)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",s),r([].slice.call(arguments))}y(e,t,o,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&y(e,"error",t,r)}(e,s,{once:!0})})},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var a=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function l(e,t,r,n){var s,o,i,a;if(c(r),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),i=o[t]),void 0===i)i=o[t]=r,++e._eventsCount;else if("function"==typeof i?i=o[t]=n?[r,i]:[i,r]:n?i.unshift(r):i.push(r),(s=h(e))>0&&i.length>s&&!i.warned){i.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=i.length,a=l,console&&console.warn&&console.warn(a)}return e}function p(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},s=p.bind(n);return s.listener=r,n.wrapFn=s,s}function d(e,t,r){var n=e._events;if(void 0===n)return[];var s=n[t];return void 0===s?[]:"function"==typeof s?r?[s.listener||s]:[s]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(s):v(s,s.length)}function f(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function v(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function y(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function s(o){n.once&&e.removeEventListener(t,s),r(o)})}}return Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return h(this)},i.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,o=this._events;if(void 0!==o)n=n&&void 0===o.error;else if(!n)return!1;if(n){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var c=o[e];if(void 0===c)return!1;if("function"==typeof c)s(c,this,t);else{var h=c.length,l=v(c,h);for(r=0;r<h;++r)s(l[r],this,t)}return!0},i.prototype.addListener=function(e,t){return l(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return l(this,e,t,!0)},i.prototype.once=function(e,t){return c(t),this.on(e,u(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,u(this,e,t)),this},i.prototype.removeListener=function(e,t){var r,n,s,o,i;if(c(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(s=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){i=r[o].listener,s=o;break}if(s<0)return this;0===s?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,s),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,i||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var s,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(s=o[n])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},i.prototype.listeners=function(e){return d(this,e,!0)},i.prototype.rawListeners=function(e){return d(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},i.prototype.listenerCount=f,i.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},n.exports}(),o=t(s);const i="connected",a="connectionError",c="disconnected",h="message",l="ipc",p=3e4;class u extends o{onConnected(e){this.emit(i,e)}onConnectionError(e){this.emit(a,e)}onDisconnected(e){this.emit(c,e)}onMessage(e){this.emit(h,e)}connected(e){return this.on(i,e)}connectionError(e){return this.on(a,e)}disconnected(e){return this.on(c,e)}message(e){return this.on(h,e)}}var d;e.TransportType=void 0,(d=e.TransportType||(e.TransportType={}))[d.sessionStorage=10]="sessionStorage",d[d.sharedWorker=20]="sharedWorker",d[d.broadcastChannel=30]="broadcastChannel";class f extends u{constructor(){super(...arguments),this.transportType=e.TransportType.broadcastChannel}static isSupported(){return!!self.BroadcastChannel}async connect(e){let t;try{this.throwIfNotSupported();const r=new BroadcastChannel((null==e?void 0:e.storageKey)||l);return r.onmessage=e=>this.onMessage(e.data),this.channel=r,t=this.getConnectionState(),this.onConnected(t),t}catch(e){t=this.getConnectionState(),t.error=e,this.onConnectionError(t)}throw t}async disconnect(){var e;null===(e=this.channel)||void 0===e||e.close(),this.channel=void 0;const t=this.getConnectionState();return this.onDisconnected(t),t}async postMessage(e){var t;null===(t=this.channel)||void 0===t||t.postMessage(e)}getConnectionState(){return{type:e.TransportType.broadcastChannel,connected:!!this.channel}}throwIfNotSupported(){if(!f.isSupported()){const e=this.getConnectionState();throw e.error=new Error("Broadcast Channel is not supported"),e}}}class v extends u{constructor(){super(...arguments),this.transportType=e.TransportType.sessionStorage,this.isConnected=!1,this.keyPrefix=l,this.messageTime=new Date(0,0,0,0,0,0,0),this.messageExpiredTime=p,this.lastClearTime=new Date(0,0,0,0,0,0,0),this.maxStorageCleanTime=9e4,this.beforeunloadHandler=()=>this.disconnect(),this.storageHandler=e=>{var t;(null===(t=e.key)||void 0===t?void 0:t.startsWith(this.keyPrefix))&&this.onStorageChange()}}static isSupported(){return!!localStorage}async connect(e){let t;try{this.throwIfNotSupported(),this.keyPrefix=(null==e?void 0:e.storageKey)||l,this.messageExpiredTime=(null==e?void 0:e.storageExpiredTime)||p,this.maxStorageCleanTime=3*this.messageExpiredTime,this.subscribeStorage(),window.addEventListener("beforeunload",this.beforeunloadHandler),this.messageTime=new Date,this.isConnected=!0,t=this.getConnectionState(),this.onConnected(t)}catch(e){throw t=this.getConnectionState(),t.error=e,this.onConnectionError(t),t}return t}throwIfNotSupported(){if(!v.isSupported()){const e=this.getConnectionState();throw e.error=new Error("Session Storage is not supported"),e}}getConnectionState(){return{type:this.transportType,connected:v.isSupported()&&this.isConnected}}subscribeStorage(){addEventListener("storage",this.storageHandler)}async disconnect(){this.clearOldMessagesTimeout&&(clearTimeout(this.clearOldMessagesTimeout),this.clearOldMessagesTimeout=void 0),this.clearOldMessages(),removeEventListener("beforeunload",this.beforeunloadHandler),removeEventListener("storage",this.storageHandler),this.isConnected=!1;const e=this.getConnectionState();return this.onDisconnected(e),e}async postMessage(e){if(!this.isConnected)return;const t=new Date;this.setMessageItem(e,t),await this.runClearOldMessages()}setMessageItem(e,t){const r=`${this.keyPrefix}_msg_${t.getTime()}`,n={date:t,message:e},s=JSON.stringify(n);this.messageTime=t,localStorage.setItem(r,s)}removeItem(e){localStorage.removeItem(e)}getKeys(e){const t=[];for(let r=0;r<localStorage.length;r++){const n=localStorage.key(r);(null==n?void 0:n.startsWith(e))&&t.push(n)}return t}async clearOldMessages(){this.getKeys(`${this.keyPrefix}_msg_`).forEach(e=>{const t=localStorage.getItem(e);try{if(t){const r=JSON.parse(t),n=new Date,s=null==r?void 0:r.date,o=new Date(s);(!o||n.getTime()-o.getTime()>this.messageExpiredTime)&&this.removeItem(e)}else this.removeItem(e)}finally{}}),this.lastClearTime=new Date}runClearOldMessages(){this.clearOldMessagesTimeout&&clearTimeout(this.clearOldMessagesTimeout);(new Date).getTime()-this.lastClearTime.getTime()>this.maxStorageCleanTime?this.clearOldMessages():this.clearOldMessagesTimeout=setTimeout(()=>this.clearOldMessages(),this.messageExpiredTime)}onStorageChange(){const e=this.getKeys(`${this.keyPrefix}_msg_`);let t=this.messageTime;e.forEach(e=>{const r=localStorage.getItem(e);try{if(r){const e=JSON.parse(r),n=null==e?void 0:e.date,s=new Date(n);s>this.messageTime&&(this.onMessage(e.message),s>t&&(t=s))}else this.removeItem(e)}finally{}}),this.messageTime=t,this.runClearOldMessages()}}class y extends u{constructor(){super(...arguments),this.beforeunloadHandler=()=>this.disconnect(),this.transportType=e.TransportType.sharedWorker}static isSupported(){return!!window.SharedWorker}throwIfNotSupported(){if(!y.isSupported())throw new Error("SharedWorker is not supported")}async connect(e){let t;try{if(this.throwIfNotSupported(),this.throwIfNotWorkerUri(e),this.worker=await this.createWorker(e),this.startWorker(this.worker),t=this.getConnectionState(),t.connected)return addEventListener("beforeunload",this.beforeunloadHandler),this.onConnected(t),t}catch(e){t=this.getConnectionState(),t.error=e,this.onConnectionError(t)}throw t}throwIfNotWorkerUri(e){if(!(null==e?void 0:e.sharedWorkerUri))throw new Error("Worker URI is not defined")}getConnectionState(){var e;return{type:this.transportType,connected:!!(null===(e=this.worker)||void 0===e?void 0:e.port)}}async createWorker(e){const t=e.sharedWorkerUri;if(!await this.isFileExists(t))throw new Error(`File ${t} does not exist`);return new SharedWorker(t)}isFileExists(e){return new Promise(t=>{const r=new XMLHttpRequest;r.open("HEAD",e),r.send(),r.onload=()=>{t(r.status<400)},r.onerror=()=>{t(!1)}})}startWorker(e){e.port.onmessage=e=>{this.onMessage(e.data.message)},e.port.start()}async disconnect(){var e,t;if(this.worker){try{this.worker.port.postMessage({cmd:"x"})}finally{null===(t=null===(e=this.worker)||void 0===e?void 0:e.port)||void 0===t||t.close(),this.worker=void 0}removeEventListener("beforeunload",this.beforeunloadHandler)}const r=this.getConnectionState();return this.onDisconnected(r),r}async postMessage(e){var t;null===(t=this.worker)||void 0===t||t.port.postMessage({cmd:"m",message:e})}}class g extends u{constructor(e){super(),this.options={},this.extendOptions(e)}get transportType(){var e;return null===(e=this.transport)||void 0===e?void 0:e.transportType}extendOptions(e){this.options={...this.options,...e},this.options.transportTypes=this.initTransportTypes(e),this.options.sharedWorkerUri=this.options.sharedWorkerUri||g.defaultWorkerUri,this.options.storageKey=this.options.storageKey||l,this.options.storageExpiredTime=this.options.storageExpiredTime||p}initTransportTypes(t){return!(null==t?void 0:t.transportTypes)||Array.isArray(null==t?void 0:t.transportTypes)&&!t.transportTypes.length?[e.TransportType.broadcastChannel,e.TransportType.sharedWorker,e.TransportType.sessionStorage]:Array.isArray(null==t?void 0:t.transportTypes)&&t.transportTypes.length?t.transportTypes:[t.transportTypes]}connect(e){return this.extendOptions(e),this.connectTransport(this.options).then(e=>(this.subscribeTransport(),e))}connectTransport(t,r=0){return!Array.isArray(t.transportTypes)||!t.transportTypes.length||r>=t.transportTypes.length||!t.transportTypes[r]?this.failConnect():(this.transport=function(t){switch(t){case e.TransportType.sessionStorage:return new v;case e.TransportType.sharedWorker:return new y;case e.TransportType.broadcastChannel:return new f;default:throw new Error(`Unknown transport type: ${t}`)}}(t.transportTypes[r]),this.transport.connect(t).catch(e=>{if(++r,Array.isArray(t.transportTypes)&&r<t.transportTypes.length)return this.connectTransport(t,r);throw e}))}subscribeTransport(){this.transport.connected(e=>this.onConnected(e)),this.transport.connectionError(e=>this.onConnectionError(e)),this.transport.disconnected(e=>this.onDisconnected(e)),this.transport.message(e=>this.onMessage(e))}unsubscribeTransport(){var e,t,r,n;null===(e=this.transport)||void 0===e||e.removeAllListeners(i),null===(t=this.transport)||void 0===t||t.removeAllListeners(a),null===(r=this.transport)||void 0===r||r.removeAllListeners(c),null===(n=this.transport)||void 0===n||n.removeAllListeners(h)}failConnect(){const e={type:null,error:"Network transport not found",connected:!1};return this.onConnectionError(e),Promise.reject(e)}disconnect(){var e,t;try{return this.unsubscribeTransport(),null!==(t=null===(e=this.transport)||void 0===e?void 0:e.disconnect())&&void 0!==t?t:Promise.reject(new Error("Undefined connection"))}catch(e){return Promise.reject(e)}finally{this.unsubscribeEvents()}}unsubscribeEvents(){this.removeAllListeners(i),this.removeAllListeners(a),this.removeAllListeners(c),this.removeAllListeners(h)}async postMessage(e){return this.transport||await this.connect(),this.transport.postMessage(e)}}g.defaultWorkerUri="//lopatnov.github.io/browser-tab-ipc/dist/ipc-worker.js",e.BrowserTabIPC=g,e.EventConnected=i,e.EventConnectionError=a,e.EventDisconnected=c,e.EventMessage=h});
//# sourceMappingURL=library.umd.min.js.map
